<!--
================================================================================
| AUTOR: M.Sc. Christian Kitzel, Hochschule Düsseldorf (HSD)                   |
| LIZENZ: Proprietär - Siehe LICENSE.md für Details                            |
| Copyright (c) 2025 M.Sc. Christian Kitzel, Hochschule Düsseldorf             |
================================================================================
-->

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>System Update - ESP32</title>
    <style>
        /* Zusätzliche Stile speziell für diese Seite */
        .update-card {
            margin-bottom: 20px;
        }
        .button {
            margin-top: 15px;
        }
        .upload-status {
            display: none; /* Standardmäßig ausgeblendet */
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .upload-status.success {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }
        .upload-status.error {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        .upload-status.progress {
            background-color: rgba(23, 162, 184, 0.2);
            border: 1px solid var(--info-color);
            color: var(--info-color);
        }
        progress {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="section">
        <h2><i class="fas fa-cloud-upload-alt"></i> System Update</h2>
        <div class="grid-container">

            <!-- Karte für Firmware Update -->
            <div class="card update-card">
                <div class="card-header">
                    <i class="fas fa-microchip"></i>
                    <h3>Firmware Updates</h3>
                </div>
                <p>Wählen Sie eine `.bin`-Datei aus, um die Gerätesoftware zu aktualisieren. Das Gerät wird nach einem erfolgreichen Update automatisch neu gestartet.</p>
                <form id="firmware-form">
                    <div class="form-group">
                        <input type="file" name="firmware" accept=".bin" required>
                    </div>
                    <button type="submit" class="button">Firmware hochladen</button>
                </form>
                <div id="firmware-status" class="upload-status"></div>
            </div>

            <!-- Karte für Dateisystem Update -->
            <div class="card update-card">
                <div class="card-header">
                    <i class="far fa-folder-open"></i>
                    <h3>Dateisystem (SPIFFS) Updates</h3>
                </div>
                <p>Wählen Sie eine `spiffs.bin`-Datei aus, um alle Web-Dateien (HTML, CSS) zu aktualisieren. Das Gerät wird danach automatisch neu gestartet.</p>
                <form id="spiffs-form">
                    <div class="form-group">
                        <input type="file" name="filesystem" accept=".bin" required>
                    </div>
                    <button type="submit" class="button">Dateisystem hochladen</button>
                </form>
                <div id="spiffs-status" class="upload-status"></div>
            </div>

        </div>
    </div>

    <iframe id="main-navbar" src="navbar.html" style="position: fixed; bottom: 0; left: 0; width: 100%; border: none; z-index: 1000; display: block;"></iframe>

    <script>
        // Funktion zum Behandeln des Uploads
        function handleUpload(formId, url, statusId) {
            const form = document.getElementById(formId);
            const statusDiv = document.getElementById(statusId);
            const fileInput = form.querySelector('input[type="file"]');

            form.addEventListener('submit', function(event) {
                event.preventDefault();

                if (fileInput.files.length === 0) {
                    statusDiv.textContent = 'Bitte wählen Sie eine Datei aus.';
                    statusDiv.className = 'upload-status error';
                    statusDiv.style.display = 'block';
                    return;
                }

                // Wir holen uns die Datei direkt, nicht über FormData
                const file = fileInput.files[0];
                const xhr = new XMLHttpRequest();

                xhr.open('POST', url, true);

                // WICHTIG: Wir sagen dem Server, dass ein binärer Stream kommt.
                // Dadurch werden keine Multipart-Header (WebKitFormBoundary...) gesendet,
                // die sonst als "falsche Bytes" in den Flash geschrieben würden.
                xhr.setRequestHeader('Content-Type', 'application/octet-stream');

                // Fortschrittsanzeige
                xhr.upload.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        statusDiv.innerHTML = `Upload läuft... ${Math.round(percentComplete)}% <progress value="${event.loaded}" max="${event.total}"></progress>`;
                        statusDiv.className = 'upload-status progress';
                        statusDiv.style.display = 'block';
                    }
                };

                // Nach Abschluss
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        statusDiv.textContent = xhr.responseText;
                        statusDiv.className = 'upload-status success';
                        alert('Update erfolgreich! Das Gerät startet jetzt neu. Bitte warten Sie einen Moment, bevor Sie die Seite neu laden.');
                        setTimeout(() => window.location.href = '/', 10000); // Nach 10s zur Startseite
                    } else {
                        statusDiv.textContent = `Fehler: ${xhr.statusText} - ${xhr.responseText}`;
                        statusDiv.className = 'upload-status error';
                    }
                    statusDiv.style.display = 'block';
                };

                // Bei Fehler
                xhr.onerror = function() {
                    statusDiv.textContent = 'Upload fehlgeschlagen. Überprüfen Sie die Netzwerkverbindung.';
                    statusDiv.className = 'upload-status error';
                    statusDiv.style.display = 'block';
                };

                // WICHTIG: Sende die Datei direkt ("Raw")
                xhr.send(file);
            });
        }

        // Initialisiere die Handler für beide Formulare
        handleUpload('firmware-form', '/update', 'firmware-status');
        handleUpload('spiffs-form', '/update_spiffs', 'spiffs-status');
    </script>
</body>
</html>